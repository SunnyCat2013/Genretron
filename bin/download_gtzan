#!/usr/bin/env python
import sys
import os
import shutil
import urllib2
import tarfile
import genretron.utils as utils

__authors__ = "Carmine Paolino"
__copyright__ = "Copyright 2015, Vrije Universiteit Amsterdam"
__credits__ = ["Carmine Paolino"]
__license__ = "3-clause BSD"
__email__ = "carmine@paolino.me"


gtzan_origin = "http://opihi.cs.uvic.ca/sound/genres.tar.gz"
gtzan_base_path = os.path.join(os.environ["PYLEARN2_DATA_PATH"], "GTZAN")


def download(url, file_name):
    u = urllib2.urlopen(url)
    f = open(file_name, 'wb')
    meta = u.info()
    file_size = int(meta.getheaders("Content-Length")[0])
    print("Downloading: {0} Bytes: {1}".format(url, file_size))

    file_size_dl = 0
    block_sz = 8192
    while True:
        buffer = u.read(block_sz)
        if not buffer:
            break

        file_size_dl += len(buffer)
        f.write(buffer)
        p = float(file_size_dl) / file_size
        status = r"{0}  [{1:.2%}]".format(file_size_dl, p)
        status = status + chr(8)*(len(status)+1)
        sys.stdout.write(status)

    f.close()

if __name__ == '__main__':
    gtzan_dest = os.path.join(gtzan_base_path, os.path.basename(gtzan_origin))

    if os.path.isdir(gtzan_base_path):
        if os.path.isfile(gtzan_dest):
            if utils.query_yes_no(
                "GTZAN dataset already downloaded in {0}. \
Do you want to download it again?".format(gtzan_dest)):
                os.remove(gtzan_dest)
                download(gtzan_origin, gtzan_dest)
        else:
            download(gtzan_origin, gtzan_dest)
    else:
        print("GTZAN base path {0} not found. Creating...".format(gtzan_base_path))
        os.makedirs(gtzan_base_path)
        download(gtzan_origin, gtzan_dest)

    print("Extracting audio files to {0}".format(gtzan_base_path))
    tar = tarfile.open(gtzan_dest, 'r:gz')
    tar.extractall(gtzan_base_path)
    tar.close()

    # flatten dir structure
    genre_dir = os.path.join(gtzan_base_path, 'genres')
    for genre in os.listdir(genre_dir):
        shutil.move(
            os.path.join(genre_dir, genre),
            os.path.join(gtzan_base_path, genre)
        )
    os.rmdir(genre_dir)

    print("All done.")
